package com.sequenceiq.cloudbreak.cloud.gcp;

import java.io.IOException;
import java.util.Optional;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.api.client.googleapis.json.GoogleJsonResponseException;
import com.sequenceiq.cloudbreak.cloud.CloudPlatformAware;
import com.sequenceiq.cloudbreak.cloud.gcp.service.checker.AbstractGcpComputeBaseResourceChecker;
import com.sequenceiq.cloudbreak.cloud.gcp.util.GcpExceptionUtil;
import com.sequenceiq.cloudbreak.cloud.gcp.util.GcpGetSupplier;
import com.sequenceiq.cloudbreak.cloud.model.Platform;
import com.sequenceiq.cloudbreak.cloud.model.Variant;
import com.sequenceiq.common.api.type.ResourceType;

public abstract class AbstractGcpResourceBuilder extends AbstractGcpComputeBaseResourceChecker implements CloudPlatformAware {

    private static final Logger LOGGER = LoggerFactory.getLogger(AbstractGcpResourceBuilder.class);

    @Override
    public Platform platform() {
        return GcpConstants.GCP_PLATFORM;
    }

    @Override
    public Variant variant() {
        return GcpConstants.GCP_VARIANT;
    }

    protected String description() {
        return "Generated by CDP.";
    }

    protected <T> Optional<T> fetchFromProvider(GcpGetSupplier<T> supplier, String name)
            throws IOException {
        try {
            T t = supplier.get();
            LOGGER.debug("Fetched resource {} - {} from provider: {}", name, resourceType(), t);
            return Optional.ofNullable(t);
        } catch (GoogleJsonResponseException e) {
            if (GcpExceptionUtil.resourceNotFoundException(e)) {
                LOGGER.debug("Resource {} - {} not found on provider", name, resourceType());
                return Optional.empty();
            } else {
                throw new GcpResourceException("Fetching resource from provider failed", resourceType(), name, e);
            }
        }
    }

    public abstract ResourceType resourceType();
}
