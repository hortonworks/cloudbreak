#!/bin/bash -ex

main() {
  $(pwd)/gradlew -q javaToolchains

  $(pwd)/gradlew -Penv=jenkins -b build.gradle \
    test \
    jacocoTestReport \
    -x checkstyleMain \
    -x checkstyleTest \
    -x spotbugsMain \
    -x spotbugsTest \
    --no-daemon --quiet --parallel -Dorg.gradle.jvmargs="-Xmx4096m -XX:MaxMetaspaceSize=256m -XX:+HeapDumpOnOutOfMemoryError"

  if [[ `git status --porcelain` ]]; then
    echo "There are local changes in git, which are autogenerated and not added in PR."
    echo ""
    echo "The following files were modified or generated during the build:"
    git status --porcelain
    exit 1
  fi
}

source $(pwd)/.github/workflows/pull-request/steps/prerequisites.sh
main "$@"