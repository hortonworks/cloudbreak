See detailed description in the commit message.