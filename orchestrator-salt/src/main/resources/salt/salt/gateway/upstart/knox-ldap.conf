# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific

#knox-ldap
description     "knox-ldap"

start on runlevel [2345]
stop on runlevel [06]

env DAEMON=/usr/hdp/current/knox-server/bin/ldap.sh
env SERVICE_NAME=knox-ldap
env SERVICE_PID_FILE=/var/run/knox/ldap.pid

#expect daemon

script
  mkdir -p /var/log/upstart
  echo "[`date`] Starting $SERVICE_NAME" >> /var/log/upstart/$SERVICE_NAME.log
  su -c "$DAEMON start" knox
  echo "[`date`] Running $SERVICE_NAME" >> /var/log/upstart/$SERVICE_NAME.log
end script

# http://stackoverflow.com/questions/9972023/ubuntu-upstart-and-creating-a-pid-for-monitoring
post-start script
  echo "[`date`] Get $SERVICE_NAME PID" >> /var/log/upstart/$SERVICE_NAME.log
  PID=`status $SERVICE_NAME | egrep -oi '([0-9]+)$' | head -n1`
  echo $PID > $SERVICE_PID_FILE
  echo "[`date`] PID of $SERVICE_NAME $PID" >> /var/log/upstart/$SERVICE_NAME.log
end script

pre-stop script
  echo "[`date`] Stopping $SERVICE_NAME" >> /var/log/upstart/$SERVICE_NAME.log
  su -c "$DAEMON stop" knox
end script

post-stop script
  echo "[`date`] Delete $SERVICE_NAME PID" >> /var/log/upstart/$SERVICE_NAME.log
  rm -f $SERVICE_PID_FILE
end script
