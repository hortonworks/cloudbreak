#!/usr/bin/env bash

function cleanup() {
  kdestroy
}

trap cleanup EXIT

ipa-client-install --unattended --uninstall

set -e
ipa-client-install \
  --realm={{ pillar['sssd-ipa']['realm'] }} \
  --domain={{ pillar['sssd-ipa']['domain'] }} \
  --mkhomedir \
  --principal={{ pillar['sssd-ipa']['principal'] }} \
  {%- if "ID_BROKER_CLOUD_IDENTITY_ROLE" in grains.get('roles', []) %}
    --no-sshd \
    --no-ssh \
  {%- endif %}
  --password "$PW" \
  --unattended \
  --force-join \
  --ssh-trust-dns \
  --no-ntp

echo "$PW" | kinit {{ pillar['sssd-ipa']['principal'] }}

ipa env

HOSTNAME=$(hostname)

# check the dns record 3 times with a 10 seconds interval (see CB-14171)
for attempt in {1..3}
do
  sleep 10
  echo "checking dns record hostname for ${HOSTNAME}, attempt ${attempt}"
  if ipa dnsrecord-show {{ pillar['sssd-ipa']['domain'] }}. "${HOSTNAME}"; then
    echo "ipa-client-install created the DNS record for ${HOSTNAME}"
    break
  fi
  if [[ "$attempt" -eq 3 ]]; then
    echo "Failed to add DNS record for ${HOSTNAME}"
    false
  fi
done

set +e
